<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Colecci√≥n | Biblioteca</title>

  <link rel="stylesheet" href="../../css/global.css">
  <link rel="stylesheet" href="../lector/lector.css">
  <link rel="stylesheet" href="biblioteca.css">

  <style>
    .card h3 {
      width: 100%;
      font-size: clamp(11px, 2.2vw, 14px);
      word-break: break-word;
      overflow-wrap: anywhere;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>

<body data-page="Biblioteca">
  
  <div id="navbar-root"></div>
  <header class="topbar">
    <div class="topbar-left">
      <div class="logo-circle">B</div>
      <div class="titles">
        <h1>Colecci√≥n</h1>
        <span class="subtitle">Tus PDFs y libros en un solo lugar</span>
      </div>
    </div>

    <div class="actions">
      <!-- ========= BUSCADOR PRINCIPAL FUNCIONAL ========= -->
      <input type="text" class="search" placeholder="Buscar en tu colecci√≥n..." id="buscador">

      <button class="add-btn" id="agregarPDF">+ Agregar PDF</button>
      <input type="file" id="inputArchivoPdfReal" accept="application/pdf" hidden>
    </div>
  </header>
  
  <div class="body">

    <main class="content">
      <section class="filters">
        <button class="pill active" data-filter="todos">Todos</button>
        <button class="pill" data-filter="recientes">Recientes</button>
        <button class="pill" data-filter="favoritos">Favoritos</button>
      </section>

      <section class="grid-container" id="grid-container"></section>
    </main>
  </div>
  <!-- Tu modal existente se conserva - no lo redefino aqu√≠ -->

  <!-- PDF.js (lib) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script>
    const inputBtn = document.getElementById("agregarPDF");
    const inputFile = document.getElementById("inputArchivoPdfReal");
    const grid = document.getElementById("grid-container");
    const buscador = document.getElementById("buscador");

    // Abrir selector de archivos PDFs
    inputBtn.addEventListener("click", () => inputFile.click());

    // Cuando se selecciona un PDF ‚Üí guardar nombre con metadata inicial tambi√©n
    inputFile.addEventListener("change", () => {
      const file = inputFile.files[0];
      if (!file) return;

      const library = JSON.parse(localStorage.getItem("pdfLibrary") || "[]");

      // crear objeto inicial
      const nuevoLibro = {
        id: Date.now(),
        nombre: file.name,
        etiquetas: ["PDF", "Nuevo"], // tags iniciales
        favorito: false,
        fecha: new Date().toLocaleDateString()
      };

      library.unshift(nuevoLibro);
      localStorage.setItem("pdfLibrary", JSON.stringify(library));

      renderizarBiblioteca();
      inputFile.value = "";
    });

    // Renderizar biblioteca por cards
    function renderizarBiblioteca() {
      const library = JSON.parse(localStorage.getItem("pdfLibrary") || "[]");
      grid.innerHTML = "";

      if (library.length === 0) {
        grid.innerHTML = `<p style="color: var(--text-muted); font-size:14px;margin-top:1rem;">
            No hay PDFs agregados a√∫n. Usa el bot√≥n de arriba para a√±adir uno.
        </p>`;
        return;
      }

      library.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="thumb"></div>
          <h3>${item.nombre}</h3>

          <div style="display:flex;gap:8px;margin-top:10px;">
            <button class="view-pdf-btn detail-btn" style="flex:1;">üìò Abrir</button>
            <button class="edit-metadata-btn detail-btn" style="flex:1;">‚úè Modificar</button>
          </div>

          <div style="margin-top:6px;font-size:11px;color: var(--text-muted);">
            ${item.fecha} ‚Ä¢ etiquetas: ${item.etiquetas.join(", ")}
          </div>
        `;

        // Abrir lector (est√°tico)
        card.querySelector(".view-pdf-btn").addEventListener("click", () => {
          window.location.href = "../lector/lector.html?pdf=" + encodeURIComponent(item.nombre);
        });

        // Abrir modal de modificar metadata (ya existente en tu UI)
        card.querySelector(".edit-metadata-btn").addEventListener("click", () => {
          abrirModalDeEdicion(item);
        });

        grid.appendChild(card);
      });
    }

    // Abrir modal de edici√≥n de metadata
    function abrirModalDeEdicion(item) {
      const modal = document.getElementById("detalleModal");
      if (!modal) {
        alert("No se encontr√≥ el modal de edici√≥n en el HTML");
        return;
      }
      const titleInput = document.getElementById("detalleTitleInput");
      const fechaSpan = document.getElementById("detalleFechaSpan");
      const idSpan = document.getElementById("detalleIdSpan");
      const tagsContainer = document.getElementById("detalleTagsContainer");

      titleInput.value = item.nombre;
      fechaSpan.textContent = item.fecha;
      idSpan.textContent = item.id;
      tagsContainer.innerHTML = "";

      item.etiquetas.forEach(tag => {
        const chip = document.createElement("div");
        chip.className = "tag-chip";
        chip.innerHTML = `${tag} <button class="tag-remove" onclick="eliminarTag(${item.id}, '${tag}')">√ó</button>`;
        tagsContainer.appendChild(chip);
      });

      modal.classList.add("is-open");
    }

    function eliminarTag(id, tag) {
      const library = JSON.parse(localStorage.getItem("pdfLibrary") || "[]");
      const libro = library.find(i => i.id === id);
      if (!libro) return;

      libro.etiquetas = libro.etiquetas.filter(t => t !== tag);
      localStorage.setItem("pdfLibrary", JSON.stringify(library));
      renderizarBiblioteca();

      abrirModalDeEdicion(libro);
    }

    // Buscador funcional por nombre + tags
    buscador.addEventListener("input", () => {
      const query = buscador.value.trim().toLowerCase();
      const cards = [...document.querySelectorAll(".card")];

      cards.forEach(card => {
        const nombre = card.querySelector("h3")?.textContent.toLowerCase() || "";
        const etiquetas = card.textContent.toLowerCase();

        card.style.display = (nombre.includes(query) || etiquetas.includes(query)) ? "" : "none";
      });
    });

    // Inicializar
    window.addEventListener("DOMContentLoaded", renderizarBiblioteca);
  </script>

  <script>window.NAVBAR_PATH="../navbar.html"</script>
  <script src="../../navbar.js"></script>
  <script src="../../js/voz-global.js"></script>

</body>
</html>
